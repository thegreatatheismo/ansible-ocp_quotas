---
- name: Create Kustomize Overlay for Resource Quotas
  hosts: localhost
  gather_facts: false

  vars:
    # Define your resource quota limits here
    cpu_limit: "500m"     # Example CPU limit
    memory_limit: "512Mi" # Example memory limit

  tasks:
    - name: Create Kustomization file
      copy:
        content: |
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          namespace: your_namespace

          resources:
            - resource-quota.yaml

          patchesStrategicMerge:
            - resource-quota-patch.yaml
        dest: "{{ playbook_dir }}/kustomization.yaml"

    - name: Create Resource Quota YAML
      copy:
        content: |
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: resource-quota
          spec:
            hard:
              requests.cpu: "{{ cpu_limit }}"
              requests.memory: "{{ memory_limit }}"
              limits.cpu: "{{ cpu_limit }}"
              limits.memory: "{{ memory_limit }}"
        dest: "{{ playbook_dir }}/resource-quota.yaml"

    - name: Create Kustomize Patch YAML
      copy:
        content: |
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: resource-quota
          spec:
            hard:
              requests.cpu: "{{ cpu_limit }}"
              requests.memory: "{{ memory_limit }}"
              limits.cpu: "{{ cpu_limit }}"
              limits.memory: "{{ memory_limit }}"
        dest: "{{ playbook_dir }}/resource-quota-patch.yaml"

    - name: Run Kustomize build
      command: kustomize build "{{ playbook_dir }}"
      register: kustomize_output

    - name: Apply Kustomize output
      shell: kubectl apply -f -
      args:
        stdin: "{{ kustomize_output.stdout_lines | join('\n') }}"
      register: kustomize_apply_result
      when: kustomize_output.stdout_lines | length > 0

    - name: Print Kustomize apply result
      debug:
        var: kustomize_apply_result.stdout_lines
      when: kustomize_apply_result is defined